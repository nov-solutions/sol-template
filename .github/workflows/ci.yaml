name: Template CI

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/hydrogen"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install pre-commit
          cd nextjs && npm ci

      - name: Run pre-commit
        run: pre-commit run --all-files

  template-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Verify setup script syntax
        run: python -m py_compile setup_project.py

      - name: Verify template config is valid JSON
        run: python -c "import json; json.load(open('template.config.json'))"

      - name: Check template variable consistency
        run: |
          echo "Checking template variables..."
          grep -oP '"\{\{[A-Z_]+\}\}"' setup_project.py | sort -u > /tmp/defined_vars.txt
          grep -roh '\{\{[A-Z_]*\}\}' --include="*.py" --include="*.yaml" --include="*.ts" --include="*.tsx" --include="*.conf" --include="Makefile" . 2>/dev/null | \
            grep -v "\.State\." | sort -u | sed 's/^/"/;s/$/"/' > /tmp/used_vars.txt || true
          echo "Defined: $(cat /tmp/defined_vars.txt | wc -l) | Used: $(cat /tmp/used_vars.txt | wc -l)"
